(ns advent-of-code-2019.day-20-test
  (:require [advent-of-code-2019.day-20 :as sut]
            [clojure.test :as test]
            [clojure.repl :refer :all]))

(def sample-maze-1
  "         A
         A
  #######.#########
  #######.........#
  #######.#######.#
  #######.#######.#
  #######.#######.#
  #####  B    ###.#
BC...##  C    ###.#
  ##.##       ###.#
  ##...DE  F  ###.#
  #####    G  ###.#
  #########.#####.#
DE..#######...###.#
  #.#########.###.#
FG..#########.....#
  ###########.#####
             Z
             Z       ")

(test/deftest read-maze-1
  (test/is (= {:path
               #{[3 15] [13 3] [13 15] [17 5] [2 8] [17 6] [12 13] [15 3] [5 10]
                 [17 12] [9 6] [11 13] [9 3] [4 10] [3 13] [4 9] [2 13] [16 3]
                 [14 15] [17 4] [11 12] [4 8] [13 13] [11 3] [2 15] [17 3] [17 14]
                 [17 10] [9 2] [17 15] [17 11] [3 14] [12 3] [13 16] [17 13] [9 5]
                 [6 10] [3 8] [9 4] [16 15] [14 3] [17 9] [15 15] [10 3] [13 14]
                 [17 8] [17 7]},
               :portals
               {"FG"    [[[11 11] [11 12]] [[1 15] [2 15]]],
                [1 15]  [11 12],
                [1 13]  [6 10],
                [11 11] [2 15],
                "BC"    [[[1 8] [2 8]] [[9 7] [9 6]]],
                [1 8]   [9 6],
                [7 10]  [2 13],
                "DE"    [[[7 10] [6 10]] [[1 13] [2 13]]],
                [9 7]   [2 8]},
               :visited #{},
               :steps   0,
               :start   [9 2],
               :goal    [13 16]}
              (sut/read-maze sample-maze-1))))

(test/deftest solve-maze-1
  (test/is (= 23 (sut/solve (sut/read-maze sample-maze-1)))))

(def sample-maze-2
  "                   A
                   A
  #################.#############
  #.#...#...................#.#.#
  #.#.#.###.###.###.#########.#.#
  #.#.#.......#...#.....#.#.#...#
  #.#########.###.#####.#.#.###.#
  #.............#.#.....#.......#
  ###.###########.###.#####.#.#.#
  #.....#        A   C    #.#.#.#
  #######        S   P    #####.#
  #.#...#                 #......VT
  #.#.#.#                 #.#####
  #...#.#               YN....#.#
  #.###.#                 #####.#
DI....#.#                 #.....#
  #####.#                 #.###.#
ZZ......#               QG....#..AS
  ###.###                 #######
JO..#.#.#                 #.....#
  #.#.#.#                 ###.#.#
  #...#..DI             BU....#..LF
  #####.#                 #.#####
YN......#               VT..#....QG
  #.###.#                 #.###.#
  #.#...#                 #.....#
  ###.###    J L     J    #.#.###
  #.....#    O F     P    #.#...#
  #.###.#####.#.#####.#####.###.#
  #...#.#.#...#.....#.....#.#...#
  #.#####.###.###.#.#.#########.#
  #...#.#.....#...#.#.#.#.....#.#
  #.###.#####.###.###.#.#.#######
  #.#.........#...#.............#
  #########.###.###.#############
           B   J   C
           U   P   P               ")

(test/deftest solve-maze-2
  (test/is (= 58 (sut/solve (sut/read-maze sample-maze-2)))))

(test/deftest part-1
  (test/is (= 484 (sut/part-1))))

(test/deftest read-2-maze-1
  (test/is (= {:path
               #{[3 15] [13 3] [13 15] [17 5] [2 8] [17 6] [12 13] [15 3] [5 10]
                 [17 12] [9 6] [11 13] [9 3] [4 10] [3 13] [4 9] [2 13] [16 3]
                 [14 15] [17 4] [11 12] [4 8] [13 13] [11 3] [2 15] [17 3] [17 14]
                 [17 10] [9 2] [17 15] [17 11] [3 14] [12 3] [13 16] [17 13] [9 5]
                 [6 10] [3 8] [9 4] [16 15] [14 3] [17 9] [15 15] [10 3] [13 14]
                 [17 8] [17 7]},
               :portals
               {"FG"    [[[11 11] [11 12]] [[1 15] [2 15]]],
                [1 15]  [11 12],
                [1 13]  [6 10],
                [11 11] [2 15],
                "BC"    [[[1 8] [2 8]] [[9 7] [9 6]]],
                [1 8]   [9 6],
                [7 10]  [2 13],
                "DE"    [[[7 10] [6 10]] [[1 13] [2 13]]],
                [9 7]   [2 8]},
               :steps           0,
               :start           [9 2],
               :goal            [13 16],
               :visited         #{},
               :level           0,
               :outward-portals {[1 15] [11 12], [1 13] [6 10], [1 8] [9 6]},
               :inward-portals  {[11 11] [2 15], [7 10] [2 13], [9 7] [2 8]}}
              (sut/read-maze-2 sample-maze-1))))

(test/deftest solve-maze-1-flat
  (let [state (sut/read-maze-2 sample-maze-1)]
    (test/is (= 26 (:steps (sut/visit-flat (assoc state :pos (:start state))))))))

(test/deftest cant-solve-maze-2-flat
  (let [state (sut/read-maze-2 sample-maze-2)]
    (test/is (= Long/MAX_VALUE (:steps (sut/visit-flat (assoc state :pos (:start state))))))))

(test/deftest maze-1-portal-routes
  (test/is (= {[[2 13] [1 15]] 5,
               [[2 8] [7 10]]    7,
               [[9 6] :exit]     28,
               [[2 15] [1 13]]   5,
               [[11 12] :exit]   6,
               [:start [11 11]]  31,
               [[6 10] [1 8]]    7,
               [[9 6] [11 11]]   33,
               [[11 12] [9 7]]   33,
               [:start [9 7]]    5}
              (sut/build-portal-network (sut/read-maze-2 sample-maze-1)))))

(test/deftest maze-2-portal-routes
  (test/is (= {[[15 34] [15 27]] 11,
               [[32 23] [25 21]]     13,
               [[26 23] [25 21]]     5,
               [[11 34] [13 27]]     9,
               [[32 21] [25 21]]     11,
               [[8 21] [1 23]]       9,
               [[17 8] [21 9]]       23,
               [[32 11] [25 13]]     9,
               [:start [17 9]]       13,
               [[26 21] [25 23]]     5,
               [:start [21 9]]       13,
               [[2 23] [9 21]]       9,
               [[15 28] [15 35]]     11,
               [[32 23] [33 21]]     21,
               [[21 8] [17 9]]       23,
               [[32 21] [33 23]]     21,
               [[2 19] [1 15]]       27,
               [[21 28] [19 35]]     9,
               [[26 21] [33 23]]     13,
               [[26 23] [33 23]]     11,
               [[2 15] [1 19]]       27,
               [[26 21] [33 21]]     11,
               [[32 21] [25 23]]     13,
               [[32 23] [25 23]]     11,
               [[26 13] [33 11]]     9,
               [[13 28] [11 35]]     9,
               [[26 17] [33 17]]     11,
               [[26 23] [33 21]]     13,
               [[19 34] [21 27]]     9,
               [[32 17] [25 17]]     11}
              (sut/build-portal-network (sut/read-maze-2 sample-maze-2)))))

(test/deftest solve-part-2-maze-1
  (test/is (= 26 (sut/solve-2 (sut/read-maze-2 sample-maze-1)))))

(test/deftest solve-part-2-maze-2
  (test/is (= :failed (sut/solve-2 (sut/read-maze-2 sample-maze-2)))))

(def sample-maze-3
  "             Z L X W       C
             Z P Q B       K
  ###########.#.#.#.#######.###############
  #...#.......#.#.......#.#.......#.#.#...#
  ###.#.#.#.#.#.#.#.###.#.#.#######.#.#.###
  #.#...#.#.#...#.#.#...#...#...#.#.......#
  #.###.#######.###.###.#.###.###.#.#######
  #...#.......#.#...#...#.............#...#
  #.#########.#######.#.#######.#######.###
  #...#.#    F       R I       Z    #.#.#.#
  #.###.#    D       E C       H    #.#.#.#
  #.#...#                           #...#.#
  #.###.#                           #.###.#
  #.#....OA                       WB..#.#..ZH
  #.###.#                           #.#.#.#
CJ......#                           #.....#
  #######                           #######
  #.#....CK                         #......IC
  #.###.#                           #.###.#
  #.....#                           #...#.#
  ###.###                           #.#.#.#
XF....#.#                         RF..#.#.#
  #####.#                           #######
  #......CJ                       NM..#...#
  ###.#.#                           #.###.#
RE....#.#                           #......RF
  ###.###        X   X       L      #.#.#.#
  #.....#        F   Q       P      #.#.#.#
  ###.###########.###.#######.#########.###
  #.....#...#.....#.......#...#.....#.#...#
  #####.#.###.#######.#######.###.###.#.#.#
  #.......#.......#.#.#.#.#...#...#...#.#.#
  #####.###.#####.#.#.#.#.###.###.#.###.###
  #.......#.....#.#...#...............#...#
  #############.#.#.###.###################
               A O F   N
               A A D   M                     ")

(test/deftest solve-part-2-maze-3
  (test/is (= 396 (sut/solve-2 (sut/read-maze-2 sample-maze-3)))))
